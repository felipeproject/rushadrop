<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <title>Campeonato - Tabelas</title>
  <link rel="stylesheet" href="css/tabelas.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Scripts -->
  <script type="module">
    import { injectNavbar } from './js/navbar.js';
    injectNavbar();

    // Popup de manutenção
    window.addEventListener('load', () => {
      Swal.fire({
        title: 'Página em manutenção ⚠️',
        text: ' Algumas funcionalidades estão fora do ar. Estamos atualizando!',
        icon: 'info',
        confirmButtonText: 'OK',
        background: '#121212',
        color: '#f9fafb',
        iconColor: '#ffffff',
        confirmButtonColor: '#1f2937',
      });
    });
  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            darkbg: '#0f0f0f',
            cardbg: '#1e1e1e',
            thbg: '#2c2c2c'
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>

<body class="bg-darkbg text-white font-sans pt-24 pb-12 flex flex-col items-center min-h-screen">

  <div id="navbar" class="w-full"></div>

  <!-- Loader -->
  <div id="loader" class="flex justify-center items-center h-screen">
    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin"></div>
  </div>

  <div id="conteudo" class="w-full max-w-7xl px-5 opacity-0 transition-opacity duration-500">
    <h2 class="text-center text-2xl mb-6">Tabelas do Campeonato</h2>

    <!-- Barra superior -->
    <div id="topBar" class="flex flex-wrap justify-between items-center mb-5 gap-3">
      <div class="flex gap-3">
        <select id="arquivos" class="bg-cardbg text-white px-3 py-2 rounded-md border border-gray-700">
          <option>-- Rodadas --</option>
        </select>
        <button id="btnPontuacao" class="bg-blue-800/30 hover:bg-blue-600 px-4 py-2 rounded-md text-white text-sm">
          ℹ️
        </button>
      </div>
    </div>

    <!-- Container das tabelas -->
    <div id="tabelasContainer" class="flex flex-wrap justify-center gap-6">
      <!-- Tabela Rodada -->
      <div class="flex-1 min-w-[350px] max-w-xl bg-cardbg p-4 rounded-xl shadow-lg">
        <h3 id="tituloTabela" class="text-center text-lg mb-2">Tabela de Jogos</h3>
        <table id="tabelaRodada" class="display compact w-full text-center text-white">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Tabela Geral -->
      <div class="flex-1 min-w-[350px] max-w-xl bg-cardbg p-4 rounded-xl shadow-lg">
        <h3 class="text-center text-lg mb-2">Tabela Geral do Campeonato</h3>
        <div id="tabelaGeralContainer"></div>
      </div>
    </div>
  </div>

  <!-- Modal Pontuação -->
  <div id="modalPontuacao" class="hidden fixed inset-0 bg-black/50 z-50 flex justify-center items-center">
    <div class="bg-cardbg text-white p-6 rounded-xl w-80 relative">
      <span class="absolute top-3 right-4 text-2xl cursor-pointer close">&times;</span>
      <h3 class="text-center text-lg mb-3">Sistema de Pontuação</h3>
      <p><strong>Por colocação:</strong></p>
      <ul class="list-disc list-inside mb-2">
        <li>1º – 15 pts</li>
        <li>2º – 12 pts</li>
        <li>3º – 10 pts</li>
        <li>4º – 8 pts</li>
        <li>5º – 6 pts</li>
        <li>6º – 4 pts</li>
        <li>7º – 2 pts</li>
        <li>8º em diante – 1 pt</li>
      </ul>
      <p><strong>Adicionais:</strong> +1 ponto por kill<br>+1 ponto por participação<br>Falta = 0 pontos<br>Exemplo: 2º
        + 5 kills + participação = 18 pts</p>
    </div>
  </div>

  <!-- Notificação sutil -->
  <div id="notifAtualizacao" class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-500 pointer-events-none">
    Atualização detectada, recarregando...
  </div>

  <script type="module">
    import { TabelaRodada } from './js/tabelaRodada.js';
    import { TabelaGeral } from './js/TabelaGeral.js';
    import { injectNavbar } from './js/navbar.js';

    injectNavbar('#navbar');

    // =============================
    // Carregar tabelas
    // =============================
    window.addEventListener('DOMContentLoaded', async () => {
      const tabelaRodada = new TabelaRodada({ tabelaId: 'tabelaRodada', tituloId: 'tituloTabela' });
      await tabelaRodada.init('arquivos');

      const tabelaGeral = new TabelaGeral({ containerId: 'tabelaGeralContainer' });
      await tabelaGeral.init();

      document.getElementById('loader').style.display = 'none';
      document.getElementById('conteudo').style.opacity = 1;
    });

    // =============================
    // Modal pontuação
    // =============================
    const modal = document.getElementById("modalPontuacao");
    const btn = document.getElementById("btnPontuacao");
    const span = modal.querySelector(".close");
    btn.onclick = () => modal.classList.remove("hidden");
    span.onclick = () => modal.classList.add("hidden");
    window.onclick = e => { if (e.target == modal) modal.classList.add("hidden"); }

    // =============================
    // Reload automático via JSON com notificação sutil
    // =============================
    let ultimaAtualizacaoLocal = null;

    async function verificarAtualizacao() {
      try {
        const response = await fetch('/data/lastUpdate.json?_=' + Date.now());
        const data = await response.json();
        const ultimaAtualizacaoRemota = new Date(data.lastUpdate);

        if (!ultimaAtualizacaoLocal) {
          ultimaAtualizacaoLocal = ultimaAtualizacaoRemota;
          return;
        }

        if (ultimaAtualizacaoRemota > ultimaAtualizacaoLocal) {
          ultimaAtualizacaoLocal = ultimaAtualizacaoRemota;

          // Mostrar notificação sutil
          const notif = document.getElementById("notifAtualizacao");
          notif.classList.add("opacity-100");
          setTimeout(() => notif.classList.remove("opacity-100"), 2000);

          // Pequeno delay antes do reload
          setTimeout(() => location.reload(), 2200);
        }
      } catch (e) {
        console.error("Erro ao verificar atualização:", e);
      }
    }

    // Verificação automática a cada 30 segundos
    setInterval(verificarAtualizacao, 30000);

  </script>

</body>
</html>
