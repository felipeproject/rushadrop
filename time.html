<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Time</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="css/time.css" />
</head>

<body>
  <a href="times.html" class="btn-voltar"><i class="fa-solid fa-arrow-left"></i> Voltar</a>

  <main class="container">
    <a href="times.html" class="btn-voltar"><i class="fa-solid fa-arrow-left"></i> Voltar</a>
    <div id="content">
      <!-- Loading placeholder -->
      <section class="team-hero" aria-label="Carregando informações do time"
        style="display: flex; gap: 2rem; flex-wrap: wrap; background: #1a1a1a; border: 1px solid #2e2e2e; border-radius: 8px; padding: 1.5rem;">
        <div class="skeleton skeleton-logo"></div>
        <div class="team-info" style="flex: 1;">
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-badge"></div>
        </div>
      </section>
      <h3><i class="fa-solid fa-image"></i> Galeria</h3>
      <div class="skeleton-gallery">
        <div class="skeleton"></div>
        <div class="skeleton"></div>
        <div class="skeleton"></div>
      </div>
      <h3><i class="fa-solid fa-chart-line"></i> Desempenho dos Jogadores</h3>
      <div>
        <div class="skeleton-table-row">
          <div class="skeleton skeleton-cell name"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
        </div>
        <div class="skeleton-table-row">
          <div class="skeleton skeleton-cell name"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
        </div>
        <div class="skeleton-table-row">
          <div class="skeleton skeleton-cell name"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
          <div class="skeleton skeleton-cell"></div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { injectNavbar } from './js/navbar.js';
    injectNavbar();
  </script>

  <script>
    const rodadas = {
      DAY1: [
        'csv/DAY1/jogo1.csv',
        'csv/DAY1/jogo2.csv',
        'csv/DAY1/jogo3.csv',
      ],
      DAY2: [
        'csv/DAY2/jogo1.csv',
        'csv/DAY2/jogo2.csv',
        'csv/DAY2/jogo3.csv',
      ],
      DAY3: [
        'csv/DAY3/jogo1.csv',
        'csv/DAY3/jogo2.csv',
        'csv/DAY3/jogo3.csv',
      ],
      DAY4: [
        'csv/DAY4/jogo1.csv',
        'csv/DAY4/jogo2.csv',
        'csv/DAY4/jogo3.csv',
      ],
    };

    async function fetchCSV(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) return null;
        const text = await response.text();
        if (!text.trim()) return null;
        return text;
      } catch {
        return null;
      }
    }

    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      if (lines.length < 2) return null;
      const headers = lines[0].split(',');
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        if (row.length !== headers.length) continue;
        const entry = {};
        for (let j = 0; j < headers.length; j++) {
          entry[headers[j].trim()] = row[j].trim();
        }
        data.push(entry);
      }
      return data;
    }

    async function carregarTodosJogadores() {
      const jogadoresMap = new Map();

      for (const day of Object.keys(rodadas)) {
        const arquivos = rodadas[day];
        for (const arquivo of arquivos) {
          const csvText = await fetchCSV(arquivo);
          if (!csvText) continue;

          const jogadores = parseCSV(csvText);
          if (!jogadores) continue;

          for (const jogador of jogadores) {
            const nome = jogador.Name;
            const kills = parseInt(jogador.Kills) || 0;
            const damage = parseInt(jogador['Damage Dealt']) || 0;
            const assists = parseInt(jogador.Assists) || 0;
            const winPlace = parseInt(jogador['Win Place']) || Infinity;

            if (!jogadoresMap.has(nome)) {
              jogadoresMap.set(nome, {
                nick: nome,
                kills: kills,
                danos: damage,
                assistencias: assists,
                bestWinPlace: winPlace,
              });
            } else {
              const j = jogadoresMap.get(nome);
              j.kills += kills;
              j.danos += damage;
              j.assistencias += assists;
              j.bestWinPlace = Math.min(j.bestWinPlace, winPlace);
            }
          }
        }
      }

      return Array.from(jogadoresMap.values()).sort((a, b) => a.bestWinPlace - b.bestWinPlace);
    }

    async function loadData() {
      const tag = new URLSearchParams(window.location.search).get('tag');
      const content = document.getElementById('content');

      if (!tag) {
        content.innerHTML = '<p id="error-message">Time não especificado.</p>';
        return;
      }

      try {
        const resTimes = await fetch('dados/times.json');
        const times = await resTimes.json();

        const time = times.find(t => t.tag.toLowerCase() === tag.toLowerCase());
        if (!time) {
          content.innerHTML = `<p id="error-message">Time "${tag}" não encontrado.</p>`;
          return;
        }

        const jogadoresDetalhados = await carregarTodosJogadores();

        // Limpa nomes do time
        const jogadoresDoTime = time.jogadores.map(jog => jog.replace(/\s*\(.*?\)/g, '').trim());

        // Filtra dados de desempenho apenas para jogadores do time
        const jogadoresFiltrados = jogadoresDetalhados.filter(j =>
          jogadoresDoTime.some(nomeTime => nomeTime.toLowerCase() === j.nick.toLowerCase())
        );

        // Cria um mapa para buscar dados pelo nome (nick)
        const dadosMap = new Map(jogadoresFiltrados.map(j => [j.nick.toLowerCase(), j]));

        // Monta as linhas da tabela para cada jogador do time, usando dados ou zeros
        const linhasTabela = jogadoresDoTime.map(nomeJogador => {
          const j = dadosMap.get(nomeJogador.toLowerCase());
          if (j) {
            return `
              <tr>
                <td><a href="#" class="player-nick" data-nick="${j.nick}">${j.nick}</a></td>
                <td>${j.kills}</td>
                <td>${j.assistencias}</td>
                <td>${j.danos}</td>
              </tr>
            `;
          } else {
            return `
              <tr>
                <td>${nomeJogador}</td>
                <td>0</td>
                <td>0</td>
                <td>0</td>
              </tr>
            `;
          }
        }).join('');

        let html = `
          <section class="team-hero">
            <img src="${time.logo}" alt="Logo do time ${time.nome}" class="team-logo" aria-label="Logo do time ${time.nome}" />
            <div class="team-info">
              <h1 class="team-name">${time.nome}</h1>
              ${time.descricao ? `<p class="team-description">${time.descricao}</p>` : ''}
              <span class="status-badge status-${time.statusInscricao?.toLowerCase() || ''}">${time.statusInscricao || ''}</span>
              ${time.linkSite ? `<p><i class="fa-solid fa-link"></i> <a href="${time.linkSite}" target="_blank" rel="noopener noreferrer">Site do time</a></p>` : ''}
            </div>
          </section>
        `;

        if (time.imagens?.length) {
          html += `<h3><i class="fa-solid fa-image"></i> Galeria</h3><div class="gallery">` +
            time.imagens.map(img => `<img src="${img}" alt="Imagem do time">`).join('') +
            `</div>`;
        }

        if (time.penalidades?.length) {
          html += `<h3><i class="fa-solid fa-triangle-exclamation"></i> Penalidades</h3><ul>` +
            time.penalidades.map(p => `<li>${p}</li>`).join('') +
            `</ul>`;
        }

        // Sempre mostra tabela com jogadores
        html += `
          <h3><i class="fa-solid fa-chart-line"></i> Desempenho dos Jogadores</h3>
          <table>
            <thead>
              <tr>
                <th>Jogador</th>
                <th>Kills</th>
                <th>Assistências</th>
                <th>Danos</th>
              </tr>
            </thead>
            <tbody>
              ${linhasTabela}
            </tbody>
          </table>
        `;

        content.innerHTML = html;

        // Link para abrir op.gg do jogador
        document.querySelectorAll('.player-nick').forEach(el => {
          el.addEventListener('click', e => {
            e.preventDefault();
            const nick = e.currentTarget.dataset.nick;
            window.open(`https://op.gg/pubg/user/${encodeURIComponent(nick)}`, '_blank', 'noopener');
          });
        });

      } catch (err) {
        content.innerHTML = '<p id="error-message">Erro ao carregar os dados.</p>';
        console.error(err);
      }
    }

    // Espera 1 segundo com skeleton, depois carrega dados
    setTimeout(() => {
      loadData();
    }, 1000);
  </script>

</body>

</html>
